#!/usr/bin/env bash
set -euo pipefail

API_BASE="${API_BASE:-http://localhost:3000}"
ADMIN_EMAIL="${ADMIN_EMAIL:-admin@example.com}"
ADMIN_PASS="${ADMIN_PASS:-Admin123!}"
ADMIN_CODE="${ADMIN_CODE:-HS123456}"

echo "==[1/8] Health check => $API_BASE/health"
if ! curl -fsS "$API_BASE/health" >/dev/null; then
  echo "❌ Backend erişilemiyor. Önce ayrı terminalde: node index.js"
  exit 1
fi
echo "✅ Health OK"

echo "==[2/8] Admin register (ilk kezse 201, varsa 409 normaldir)"
curl -s -X POST "$API_BASE/register" \
  -H "Content-Type: application/json" \
  -d "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASS\",\"name\":\"Admin\"}" || true
echo

echo "==[3/8] Login → TOKEN al"
# jq yoksa Node ile token çekiyoruz
TOKEN="$(curl -s -X POST "$API_BASE/login" \
  -H "Content-Type: application/json" \
  -d "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASS\"}" \
  | node -e "process.stdin.on('data',b=>{try{console.log(JSON.parse(b).token||'')}catch{}})")"

if [ -z "${TOKEN:-}" ]; then
  echo "❌ TOKEN boş — login başarısız (şifre ya da backend hatası)."
  exit 1
fi
echo "✅ TOKEN alındı: ${TOKEN:0:16}…"

echo "==[4/8] Admin davetini kabul et (code=$ADMIN_CODE)"
curl -fsS -X POST "$API_BASE/admin/accept-invite" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"code\":\"$ADMIN_CODE\"}" >/dev/null || {
    echo "⚠️  Admin daveti kabulünde hata olabilir; devam ediyoruz."
}
echo "✅ (Varsa) admin yükseltmesi denendi"

echo "==[5/8] /me kontrol (rol ve aktiflik)"
ME_JSON="$(curl -fsS "$API_BASE/me" -H "Authorization: Bearer $TOKEN")" || {
  echo "❌ /me alınamadı"
  exit 1
}
echo "$ME_JSON"
ROLE="$(node -e "try{const o=JSON.parse(process.argv[1]);console.log(o.role||'')}catch{}" "$ME_JSON")"
echo "ℹ️  Rol: ${ROLE:-bilinmiyor}"

echo "==[6/8] Users router ping"
curl -fsS "$API_BASE/api/users/__ping" -H "Authorization: Bearer $TOKEN" || echo
echo

echo "==[7/8] Örnek kullanıcı oluştur (Nil Gül)"
curl -s -X POST "$API_BASE/api/users" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Nil Gül",
    "tc": "12345678901",
    "phone": "5551112233",
    "email": "nil@example.com",
    "serviceId": "ACIL_SERVIS",
    "role": "authorized"
  }' || echo
echo

echo "==[8/8] Bitti."
